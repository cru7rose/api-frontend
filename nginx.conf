# ========================================================================
# SPA + API reverse proxy (Cloudflare backend) + helpers (nominatim/osrm)
# Listens on 81 to match your current deployment
# ========================================================================
server {
  listen 80;
  server_name _;

  # Serve the built SPA
  root /usr/share/nginx/html;
  index index.html;

  # ---- API proxy: /api/* â†’ https://api.danxils.com/*  (strip /api) ----
  location ^~ /api/ {
    rewrite ^/api/?(.*)$ /$1 break;

    proxy_pass https://api.danxils.com;
    proxy_ssl_server_name on;
    proxy_set_header Host api.danxils.com;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 300s;
  }

  # ---- Nominatim helper -------------------------------------------------
  location ^~ /nominatim/ {
    rewrite ^/nominatim/(.*)$ /$1 break;
    proxy_pass http://10.105.0.188:8083;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # ---- OSRM helper ------------------------------------------------------
  location ^~ /osrm/ {
    rewrite ^/osrm/(.*)$ /$1 break;
    proxy_pass http://10.105.0.188:5000;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # SPA history fallback
  location / {
    try_files $uri $uri/ /index.html;
  }
}
